name: Sync to Gold

on:
  workflow_dispatch:

jobs:
  sync-to-gold:
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Clone gold repo
        run: |
          git config --global user.name "Auto Bot"
          git config --global user.email "bot@example.com"
          git clone https://x-access-token:${{ steps.generate_token.outputs.token }}@github.com/malaktolba/gold.git
          cd gold
          echo "Automated update on $(date)" >> README.md
          git checkout -b update-readme
          git add README.md
          git commit -m "Automated README update"
          git push origin update-readme
        env:
          GIT_TERMINAL_PROMPT: 0

      - name: Create Pull Request
        run: |
          gh pr create \
            --repo malaktolba/gold \
            --base master \
            --head update-readme \
            --title "Automated README Update" \
            --body "This PR was created by GitHub Actions."
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}

      - name: Auto-merge PR
        run: |
          PR_NUMBER=$(gh pr list --repo malaktolba/gold --head update-readme --json number --jq '.[0].number')
          gh pr merge $PR_NUMBER \
            --repo malaktolba/gold \
            --merge \
            --admin
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
